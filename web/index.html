<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>inMemDb ‚Äî Test Console</title>
<style>
  :root {
    --bg: #0d1117; --surface: #161b22; --border: #30363d;
    --text: #e6edf3; --dim: #8b949e; --accent: #58a6ff;
    --green: #3fb950; --red: #f85149; --yellow: #d29922;
    --font: 'Segoe UI', system-ui, sans-serif;
    --mono: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: var(--font); min-height: 100vh; display: flex; flex-direction: column; }

  header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 16px 24px; display: flex; align-items: center; gap: 16px; }
  header h1 { font-size: 20px; font-weight: 600; }
  header h1 span { color: var(--accent); }
  .status { margin-left: auto; display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--dim); }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--red); }
  .status-dot.connected { background: var(--green); }

  .container { display: flex; flex: 1; overflow: hidden; }

  .sidebar { width: 280px; background: var(--surface); border-right: 1px solid var(--border); overflow-y: auto; padding: 16px; flex-shrink: 0; }
  .sidebar h2 { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--dim); margin-bottom: 12px; }
  .cmd-group { margin-bottom: 20px; }
  .cmd-group h3 { font-size: 13px; color: var(--accent); margin-bottom: 8px; }
  .cmd-btn { display: block; width: 100%; text-align: left; background: transparent; border: 1px solid var(--border); color: var(--text); padding: 8px 10px; border-radius: 6px; font-family: var(--mono); font-size: 12px; cursor: pointer; margin-bottom: 6px; transition: all .15s; }
  .cmd-btn:hover { background: var(--border); border-color: var(--accent); }

  .console-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

  .output { flex: 1; overflow-y: auto; padding: 16px 24px; font-family: var(--mono); font-size: 13px; line-height: 1.7; }
  .output .entry { margin-bottom: 8px; }
  .output .cmd-line { color: var(--accent); }
  .output .cmd-line::before { content: "‚ùØ "; color: var(--green); }
  .output .result { color: var(--text); white-space: pre-wrap; padding-left: 16px; }
  .output .result.error { color: var(--red); }
  .output .result.nil { color: var(--dim); font-style: italic; }
  .output .ts { color: var(--dim); font-size: 11px; margin-left: 8px; }
  .output .welcome { color: var(--dim); margin-bottom: 16px; }

  .input-bar { background: var(--surface); border-top: 1px solid var(--border); padding: 12px 24px; display: flex; align-items: center; gap: 12px; }
  .input-bar label { color: var(--green); font-family: var(--mono); font-size: 14px; flex-shrink: 0; }
  .input-bar input { flex: 1; background: var(--bg); border: 1px solid var(--border); color: var(--text); font-family: var(--mono); font-size: 14px; padding: 10px 14px; border-radius: 6px; outline: none; }
  .input-bar input:focus { border-color: var(--accent); }
  .input-bar button { background: var(--accent); color: #fff; border: none; padding: 10px 20px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; }
  .input-bar button:hover { opacity: .85; }

  .kv-panel { background: var(--surface); border-top: 1px solid var(--border); padding: 12px 24px; display: flex; gap: 12px; align-items: center; }
  .kv-panel button { background: transparent; border: 1px solid var(--border); color: var(--accent); padding: 6px 14px; border-radius: 6px; font-size: 12px; cursor: pointer; }
  .kv-panel button:hover { background: var(--border); }
  .kv-panel span { font-size: 12px; color: var(--dim); }

  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  @media (max-width: 768px) { .sidebar { display: none; } }
</style>
</head>
<body>

<header>
  <h1><span>inMemDb</span> Test Console</h1>
  <div class="status">
    <div class="status-dot" id="statusDot"></div>
    <span id="statusText">Disconnected</span>
  </div>
</header>

<div class="container">
  <aside class="sidebar">
    <h2>Quick Commands</h2>

    <div class="cmd-group">
      <h3>üîë String / Int</h3>
      <button class="cmd-btn" data-cmd='SET test "hello world"'>SET test "hello world"</button>
      <button class="cmd-btn" data-cmd="GET test">GET test</button>
      <button class="cmd-btn" data-cmd="SET counter 0">SET counter 0</button>
      <button class="cmd-btn" data-cmd="INCR counter">INCR counter</button>
      <button class="cmd-btn" data-cmd="DECR counter">DECR counter</button>
      <button class="cmd-btn" data-cmd="DEL test counter">DEL test counter</button>
      <button class="cmd-btn" data-cmd="MSET a 1 b 2 c 3">MSET a 1 b 2 c 3</button>
      <button class="cmd-btn" data-cmd="MGET a b c">MGET a b c</button>
      <button class="cmd-btn" data-cmd="EXISTS test">EXISTS test</button>
    </div>

    <div class="cmd-group">
      <h3>üìã List</h3>
      <button class="cmd-btn" data-cmd="RPUSH mylist apple banana cherry">RPUSH mylist apple banana cherry</button>
      <button class="cmd-btn" data-cmd="LRANGE mylist 0 -1">LRANGE mylist 0 -1</button>
      <button class="cmd-btn" data-cmd="LPUSH mylist first">LPUSH mylist first</button>
      <button class="cmd-btn" data-cmd="LPOP mylist">LPOP mylist</button>
      <button class="cmd-btn" data-cmd="RPOP mylist">RPOP mylist</button>
      <button class="cmd-btn" data-cmd="LLEN mylist">LLEN mylist</button>
    </div>

    <div class="cmd-group">
      <h3>‚è±Ô∏è TTL</h3>
      <button class="cmd-btn" data-cmd="SET session abc EX 60">SET session abc EX 60</button>
      <button class="cmd-btn" data-cmd="EXPIRE test 30">EXPIRE test 30</button>
      <button class="cmd-btn" data-cmd="TTL test">TTL test</button>
      <button class="cmd-btn" data-cmd="PERSIST test">PERSIST test</button>
    </div>

    <div class="cmd-group">
      <h3>üñ•Ô∏è Server</h3>
      <button class="cmd-btn" data-cmd="PING">PING</button>
      <button class="cmd-btn" data-cmd="DBSIZE">DBSIZE</button>
      <button class="cmd-btn" data-cmd="INFO">INFO</button>
      <button class="cmd-btn" data-cmd="SAVE">SAVE</button>
      <button class="cmd-btn" data-cmd="FLUSHDB">FLUSHDB</button>
    </div>
  </aside>

  <main class="console-area">
    <div class="output" id="output">
      <div class="welcome">
        Welcome to the <b>inMemDb</b> test console.<br>
        Type a command below or click a quick command on the left.<br><br>
        <b>To start:</b><br>
        1. Run <code>build\inmemdb-server.exe</code><br>
        2. Run <code>node web\proxy.js</code><br>
        3. Open <code>http://localhost:8080</code>
      </div>
    </div>
    <div class="kv-panel">
      <button onclick="sendCommand('DBSIZE')">üìä DBSIZE</button>
      <button onclick="sendCommand('PING')">üèì PING</button>
      <button onclick="sendCommand('FLUSHDB')">üóëÔ∏è FLUSH ALL</button>
      <button onclick="clearOutput()">üßπ Clear Console</button>
      <span id="keyCount"></span>
    </div>
    <div class="input-bar">
      <label>‚ùØ</label>
      <input type="text" id="cmdInput" placeholder="Type a command... (e.g. SET name Alice)" autocomplete="off" spellcheck="false">
      <button onclick="submitInput()">Send</button>
    </div>
  </main>
</div>

<script>
const API = "/cmd";
const output = document.getElementById("output");
const cmdInput = document.getElementById("cmdInput");
const statusDot = document.getElementById("statusDot");
const statusText = document.getElementById("statusText");

let history = [], historyIdx = -1;

function tokenize(line) {
  const args = [];
  let i = 0;
  while (i < line.length) {
    while (i < line.length && line[i] === " ") i++;
    if (i >= line.length) break;
    if (line[i] === '"') {
      i++;
      let s = "";
      while (i < line.length && line[i] !== '"') s += line[i++];
      if (i < line.length) i++;
      args.push(s);
    } else {
      let s = "";
      while (i < line.length && line[i] !== " ") s += line[i++];
      args.push(s);
    }
  }
  return args;
}

async function sendCommand(line) {
  const args = tokenize(line.trim());
  if (args.length === 0) return;
  appendCmd(line);
  try {
    const res = await fetch(API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ args })
    });
    const data = await res.json();
    const isErr = data.result.startsWith("(error)");
    const isNil = data.result === "(nil)";
    appendResult(data.result, isErr ? "error" : isNil ? "nil" : "");
    setConnected(data.ok);
  } catch (e) {
    appendResult("Connection error: " + e.message, "error");
    setConnected(false);
  }
}

function submitInput() {
  const line = cmdInput.value.trim();
  if (!line) return;
  history.unshift(line);
  historyIdx = -1;
  sendCommand(line);
  cmdInput.value = "";
}

function appendCmd(text) {
  const ts = new Date().toLocaleTimeString();
  const div = document.createElement("div");
  div.className = "entry";
  div.innerHTML = '<div class="cmd-line">' + esc(text) + '<span class="ts">' + ts + '</span></div>';
  output.appendChild(div);
  output.scrollTop = output.scrollHeight;
}

function appendResult(text, cls) {
  const entries = output.querySelectorAll(".entry");
  const last = entries[entries.length - 1];
  const div = document.createElement("div");
  div.className = "result " + (cls || "");
  div.textContent = text;
  if (last) last.appendChild(div);
  output.scrollTop = output.scrollHeight;
}

function clearOutput() { output.innerHTML = ""; }

function esc(s) { return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }

function setConnected(ok) {
  statusDot.className = "status-dot" + (ok ? " connected" : "");
  statusText.textContent = ok ? "Connected" : "Disconnected";
}

cmdInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") { e.preventDefault(); submitInput(); }
  if (e.key === "ArrowUp") { e.preventDefault(); if (historyIdx < history.length - 1) { historyIdx++; cmdInput.value = history[historyIdx]; } }
  if (e.key === "ArrowDown") { e.preventDefault(); if (historyIdx > 0) { historyIdx--; cmdInput.value = history[historyIdx]; } else { historyIdx = -1; cmdInput.value = ""; } }
});

document.querySelectorAll(".cmd-btn").forEach(btn => {
  btn.addEventListener("click", () => { cmdInput.value = btn.getAttribute("data-cmd"); submitInput(); });
});

(async () => {
  try {
    const res = await fetch(API, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ args: ["PING"] }) });
    const data = await res.json();
    setConnected(data.ok);
  } catch { setConnected(false); }
})();

cmdInput.focus();
</script>
</body>
</html>
