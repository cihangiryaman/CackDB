<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>inMemDb ‚Äî Test Console</title>
<style>
  :root {
    --bg: #0d1117; --surface: #161b22; --border: #30363d;
    --text: #e6edf3; --dim: #8b949e; --accent: #58a6ff;
    --green: #3fb950; --red: #f85149; --yellow: #d29922;
    --orange: #e3853a;
    --font: 'Segoe UI', system-ui, sans-serif;
    --mono: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: var(--font); min-height: 100vh; display: flex; flex-direction: column; }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 14px 24px; display: flex; align-items: center; gap: 14px; position: relative; z-index: 30; }
  header h1 { font-size: 20px; font-weight: 600; }
  header h1 span { color: var(--accent); }
  .status { margin-left: auto; display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--dim); }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--red); transition: background .3s; }
  .status-dot.connected { background: var(--green); }

  /* Hamburger ‚Äî only visible on mobile */
  .hamburger { display: none; background: transparent; border: 1px solid var(--border); color: var(--text); padding: 6px 10px; border-radius: 6px; font-size: 16px; cursor: pointer; line-height: 1; }
  .hamburger:hover { background: var(--border); }

  /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
  .container { display: flex; flex: 1; overflow: hidden; position: relative; }

  /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
  .sidebar { width: 280px; background: var(--surface); border-right: 1px solid var(--border); overflow-y: auto; padding: 16px; flex-shrink: 0; display: flex; flex-direction: column; gap: 0; }
  .sidebar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
  .sidebar-header h2 { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--dim); }
  .sidebar-filter { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); font-family: var(--font); font-size: 12px; padding: 7px 10px; border-radius: 6px; outline: none; margin-bottom: 14px; }
  .sidebar-filter:focus { border-color: var(--accent); }
  .cmd-group { margin-bottom: 20px; }
  .cmd-group h3 { font-size: 13px; color: var(--accent); margin-bottom: 8px; }
  .cmd-btn { display: block; width: 100%; text-align: left; background: transparent; border: 1px solid var(--border); color: var(--text); padding: 8px 10px; border-radius: 6px; font-family: var(--mono); font-size: 12px; cursor: pointer; margin-bottom: 6px; transition: all .15s; }
  .cmd-btn:hover { background: var(--border); border-color: var(--accent); }
  .cmd-btn.hidden { display: none; }

  /* ‚îÄ‚îÄ Sidebar overlay (mobile) ‚îÄ‚îÄ */
  .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.55); z-index: 19; }
  .sidebar-overlay.active { display: block; }

  /* ‚îÄ‚îÄ Console ‚îÄ‚îÄ */
  .console-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

  .output { flex: 1; overflow-y: auto; padding: 16px 24px; font-family: var(--mono); font-size: 13px; line-height: 1.7; }
  .output .entry { margin-bottom: 8px; }

  .output .cmd-line { color: var(--accent); display: flex; align-items: baseline; flex-wrap: wrap; gap: 4px; }
  .output .cmd-line::before { content: "‚ùØ "; color: var(--green); flex-shrink: 0; }
  .output .cmd-name { color: var(--orange); font-weight: 600; }
  .output .cmd-args { color: var(--accent); }

  .output .result-wrap { position: relative; display: flex; align-items: flex-start; gap: 6px; padding-left: 16px; }
  .output .result { color: var(--text); white-space: pre-wrap; flex: 1; }
  .output .result.error { color: var(--red); }
  .output .result.nil { color: var(--dim); font-style: italic; }
  .output .copy-btn { opacity: 0; background: transparent; border: 1px solid var(--border); color: var(--dim); font-size: 11px; padding: 1px 6px; border-radius: 4px; cursor: pointer; flex-shrink: 0; transition: opacity .15s, color .15s; line-height: 1.6; margin-top: 2px; }
  .output .result-wrap:hover .copy-btn { opacity: 1; }
  .output .copy-btn:hover { color: var(--accent); border-color: var(--accent); }

  .output .ts { color: var(--dim); font-size: 11px; margin-left: 6px; }
  .output .welcome { color: var(--dim); margin-bottom: 16px; }

  /* ‚îÄ‚îÄ Quick-action bar ‚îÄ‚îÄ */
  .kv-panel { background: var(--surface); border-top: 1px solid var(--border); padding: 10px 24px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  .kv-panel button { background: transparent; border: 1px solid var(--border); color: var(--accent); padding: 5px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: background .15s; }
  .kv-panel button:hover { background: var(--border); }
  .kv-panel span { font-size: 12px; color: var(--dim); margin-left: auto; }

  /* ‚îÄ‚îÄ Input bar ‚îÄ‚îÄ */
  .input-bar { background: var(--surface); border-top: 1px solid var(--border); padding: 12px 24px; display: flex; align-items: center; gap: 12px; }
  .input-bar label { color: var(--green); font-family: var(--mono); font-size: 14px; flex-shrink: 0; }
  .input-bar input { flex: 1; background: var(--bg); border: 1px solid var(--border); color: var(--text); font-family: var(--mono); font-size: 14px; padding: 10px 14px; border-radius: 6px; outline: none; }
  .input-bar input:focus { border-color: var(--accent); }
  .input-bar input:disabled { opacity: .5; cursor: not-allowed; }
  #sendBtn { background: var(--accent); color: #fff; border: none; padding: 10px 20px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; min-width: 68px; display: flex; align-items: center; justify-content: center; gap: 6px; transition: opacity .15s; }
  #sendBtn:hover:not(:disabled) { opacity: .85; }
  #sendBtn:disabled { opacity: .55; cursor: not-allowed; }

  /* Spinner */
  .spinner { width: 14px; height: 14px; border: 2px solid rgba(255,255,255,.3); border-top-color: #fff; border-radius: 50%; animation: spin .6s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
  #toast { position: fixed; top: 20px; right: 20px; background: #1f2937; border: 1px solid var(--border); color: var(--text); font-size: 13px; padding: 10px 18px; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,.4); z-index: 100; opacity: 0; transform: translateY(-8px); transition: opacity .2s, transform .2s; pointer-events: none; }
  #toast.show { opacity: 1; transform: translateY(0); }
  #toast.success { border-color: var(--green); color: var(--green); }
  #toast.error { border-color: var(--red); color: var(--red); }

  /* ‚îÄ‚îÄ Scrollbar ‚îÄ‚îÄ */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* ‚îÄ‚îÄ Mobile ‚îÄ‚îÄ */
  @media (max-width: 768px) {
    .hamburger { display: block; }
    .sidebar {
      position: fixed; top: 0; left: 0; height: 100%; z-index: 20;
      transform: translateX(-100%); transition: transform .25s ease;
    }
    .sidebar.open { transform: translateX(0); }
  }
</style>
</head>
<body>

<header>
  <button class="hamburger" id="hamburgerBtn" aria-label="Toggle menu">‚ò∞</button>
  <h1><span>inMemDb</span> Test Console</h1>
  <div class="status">
    <div class="status-dot" id="statusDot"></div>
    <span id="statusText">Disconnected</span>
  </div>
</header>

<div id="sidebarOverlay" class="sidebar-overlay"></div>

<div class="container">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>Quick Commands</h2>
    </div>
    <input type="search" class="sidebar-filter" id="sidebarFilter" placeholder="üîç Filter commands‚Ä¶" autocomplete="off">

    <div class="cmd-group" data-group="string">
      <h3>üîë String / Int</h3>
      <button class="cmd-btn" data-cmd='SET test "hello world"'>SET test "hello world"</button>
      <button class="cmd-btn" data-cmd="GET test">GET test</button>
      <button class="cmd-btn" data-cmd="SET counter 0">SET counter 0</button>
      <button class="cmd-btn" data-cmd="INCR counter">INCR counter</button>
      <button class="cmd-btn" data-cmd="DECR counter">DECR counter</button>
      <button class="cmd-btn" data-cmd="DEL test counter">DEL test counter</button>
      <button class="cmd-btn" data-cmd="MSET a 1 b 2 c 3">MSET a 1 b 2 c 3</button>
      <button class="cmd-btn" data-cmd="MGET a b c">MGET a b c</button>
      <button class="cmd-btn" data-cmd="EXISTS test">EXISTS test</button>
    </div>

    <div class="cmd-group" data-group="list">
      <h3>üìã List</h3>
      <button class="cmd-btn" data-cmd="RPUSH mylist apple banana cherry">RPUSH mylist apple banana cherry</button>
      <button class="cmd-btn" data-cmd="LRANGE mylist 0 -1">LRANGE mylist 0 -1</button>
      <button class="cmd-btn" data-cmd="LPUSH mylist first">LPUSH mylist first</button>
      <button class="cmd-btn" data-cmd="LPOP mylist">LPOP mylist</button>
      <button class="cmd-btn" data-cmd="RPOP mylist">RPOP mylist</button>
      <button class="cmd-btn" data-cmd="LLEN mylist">LLEN mylist</button>
    </div>

    <div class="cmd-group" data-group="ttl">
      <h3>‚è±Ô∏è TTL</h3>
      <button class="cmd-btn" data-cmd="SET session abc EX 60">SET session abc EX 60</button>
      <button class="cmd-btn" data-cmd="EXPIRE test 30">EXPIRE test 30</button>
      <button class="cmd-btn" data-cmd="TTL test">TTL test</button>
      <button class="cmd-btn" data-cmd="PERSIST test">PERSIST test</button>
    </div>

    <div class="cmd-group" data-group="server">
      <h3>üñ•Ô∏è Server</h3>
      <button class="cmd-btn" data-cmd="PING">PING</button>
      <button class="cmd-btn" data-cmd="DBSIZE">DBSIZE</button>
      <button class="cmd-btn" data-cmd="INFO">INFO</button>
      <button class="cmd-btn" data-cmd="SAVE">SAVE</button>
      <button class="cmd-btn" data-cmd="FLUSHDB">FLUSHDB</button>
    </div>
  </aside>

  <main class="console-area">
    <div class="output" id="output">
      <div class="welcome">
        Welcome to the <b>inMemDb</b> test console.<br>
        Type a command below or click a quick command on the left.<br><br>
        <b>To start:</b><br>
        1. Run <code>build\inmemdb-server.exe</code><br>
        2. Run <code>node web\proxy.js</code><br>
        3. Open <code>http://localhost:8080</code>
      </div>
    </div>
    <div class="kv-panel">
      <button onclick="sendCommand('DBSIZE')">üìä DBSIZE</button>
      <button onclick="sendCommand('PING')">üèì PING</button>
      <button onclick="flushAll()">üóëÔ∏è FLUSH ALL</button>
      <button onclick="clearOutput()">üßπ Clear Console</button>
      <span id="keyCount"></span>
    </div>
    <div class="input-bar">
      <label>‚ùØ</label>
      <input type="text" id="cmdInput" placeholder="Type a command‚Ä¶ (e.g. SET name Alice)" autocomplete="off" spellcheck="false">
      <button id="sendBtn" onclick="submitInput()">Send</button>
    </div>
  </main>
</div>

<div id="toast"></div>

<script>
const API = "/cmd";
const output = document.getElementById("output");
const cmdInput = document.getElementById("cmdInput");
const statusDot = document.getElementById("statusDot");
const statusText = document.getElementById("statusText");
const sendBtn = document.getElementById("sendBtn");

let history = [], historyIdx = -1;
let busy = false;

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
let toastTimer = null;
function showToast(msg, type = "") {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.className = "show" + (type ? " " + type : "");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { t.className = ""; }, 2200);
}

/* ‚îÄ‚îÄ Tokenizer ‚îÄ‚îÄ */
function tokenize(line) {
  const args = [];
  let i = 0;
  while (i < line.length) {
    while (i < line.length && line[i] === " ") i++;
    if (i >= line.length) break;
    if (line[i] === '"') {
      i++;
      let s = "";
      while (i < line.length && line[i] !== '"') s += line[i++];
      if (i < line.length) i++;
      args.push(s);
    } else {
      let s = "";
      while (i < line.length && line[i] !== " ") s += line[i++];
      args.push(s);
    }
  }
  return args;
}

/* ‚îÄ‚îÄ Loading state ‚îÄ‚îÄ */
function setLoading(on) {
  busy = on;
  cmdInput.disabled = on;
  sendBtn.disabled = on;
  if (on) {
    sendBtn.innerHTML = '<span class="spinner"></span>';
  } else {
    sendBtn.textContent = "Send";
    cmdInput.focus();
  }
}

/* ‚îÄ‚îÄ Send command ‚îÄ‚îÄ */
async function sendCommand(line, silent = false) {
  const args = tokenize(line.trim());
  if (args.length === 0) return;
  if (!silent) appendCmd(line);
  setLoading(true);
  try {
    const res = await fetch(API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ args })
    });
    const data = await res.json();
    if (!silent) {
      const isErr = data.result.startsWith("(error)");
      const isNil = data.result === "(nil)";
      appendResult(data.result, isErr ? "error" : isNil ? "nil" : "");
    }
    setConnected(data.ok);
    return data;
  } catch (e) {
    if (!silent) appendResult("Connection error: " + e.message, "error");
    setConnected(false);
  } finally {
    setLoading(false);
  }
}

/* ‚îÄ‚îÄ FLUSHDB with confirmation ‚îÄ‚îÄ */
function flushAll() {
  if (!confirm("‚ö†Ô∏è  This will delete ALL keys from the database.\n\nAre you sure?")) return;
  sendCommand("FLUSHDB");
}

/* ‚îÄ‚îÄ Submit from input bar ‚îÄ‚îÄ */
function submitInput() {
  if (busy) return;
  const line = cmdInput.value.trim();
  if (!line) return;
  history.unshift(line);
  historyIdx = -1;
  /* Confirm dangerous commands typed manually too */
  const cmd = line.trim().toUpperCase().split(/\s+/)[0];
  if (cmd === "FLUSHDB" || cmd === "FLUSHALL") {
    if (!confirm("‚ö†Ô∏è  This will delete ALL keys from the database.\n\nAre you sure?")) return;
  }
  sendCommand(line);
  cmdInput.value = "";
}

/* ‚îÄ‚îÄ Append command line ‚îÄ‚îÄ */
function appendCmd(text) {
  const ts = new Date().toLocaleTimeString();
  const tokens = text.trim().split(/\s+/);
  const cmdName = tokens[0] || "";
  const rest = tokens.slice(1).join(" ");

  const div = document.createElement("div");
  div.className = "entry";

  const cmdLine = document.createElement("div");
  cmdLine.className = "cmd-line";

  const nameSpan = document.createElement("span");
  nameSpan.className = "cmd-name";
  nameSpan.textContent = cmdName;
  cmdLine.appendChild(nameSpan);

  if (rest) {
    const argsSpan = document.createElement("span");
    argsSpan.className = "cmd-args";
    argsSpan.textContent = " " + esc(rest);
    cmdLine.appendChild(argsSpan);
  }

  const tsSpan = document.createElement("span");
  tsSpan.className = "ts";
  tsSpan.textContent = ts;
  cmdLine.appendChild(tsSpan);

  div.appendChild(cmdLine);
  output.appendChild(div);
  output.scrollTop = output.scrollHeight;
}

/* ‚îÄ‚îÄ Append result with copy button ‚îÄ‚îÄ */
function appendResult(text, cls) {
  const entries = output.querySelectorAll(".entry");
  const last = entries[entries.length - 1];
  if (!last) return;

  const wrap = document.createElement("div");
  wrap.className = "result-wrap";

  const div = document.createElement("div");
  div.className = "result " + (cls || "");
  div.textContent = text;

  const copyBtn = document.createElement("button");
  copyBtn.className = "copy-btn";
  copyBtn.title = "Copy result";
  copyBtn.textContent = "üìã";
  copyBtn.addEventListener("click", () => {
    navigator.clipboard.writeText(text).then(() => {
      showToast("Copied to clipboard!", "success");
    }).catch(() => showToast("Copy failed", "error"));
  });

  wrap.appendChild(div);
  wrap.appendChild(copyBtn);
  last.appendChild(wrap);
  output.scrollTop = output.scrollHeight;
}

function clearOutput() { output.innerHTML = ""; }

function esc(s) { return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }

function setConnected(ok) {
  statusDot.className = "status-dot" + (ok ? " connected" : "");
  statusText.textContent = ok ? "Connected" : "Disconnected";
}

/* ‚îÄ‚îÄ Keyboard navigation ‚îÄ‚îÄ */
cmdInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") { e.preventDefault(); submitInput(); }
  if (e.key === "ArrowUp") { e.preventDefault(); if (historyIdx < history.length - 1) { historyIdx++; cmdInput.value = history[historyIdx]; } }
  if (e.key === "ArrowDown") { e.preventDefault(); if (historyIdx > 0) { historyIdx--; cmdInput.value = history[historyIdx]; } else { historyIdx = -1; cmdInput.value = ""; } }
});

/* ‚îÄ‚îÄ Quick command buttons ‚îÄ‚îÄ */
document.querySelectorAll(".cmd-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const cmd = btn.getAttribute("data-cmd");
    cmdInput.value = cmd;
    submitInput();
  });
});

/* ‚îÄ‚îÄ Sidebar filter ‚îÄ‚îÄ */
document.getElementById("sidebarFilter").addEventListener("input", function () {
  const q = this.value.trim().toLowerCase();
  document.querySelectorAll(".cmd-group").forEach(group => {
    let anyVisible = false;
    group.querySelectorAll(".cmd-btn").forEach(btn => {
      const match = !q || btn.getAttribute("data-cmd").toLowerCase().includes(q);
      btn.classList.toggle("hidden", !match);
      if (match) anyVisible = true;
    });
    group.style.display = anyVisible ? "" : "none";
  });
});

/* ‚îÄ‚îÄ Mobile sidebar toggle ‚îÄ‚îÄ */
const sidebar = document.getElementById("sidebar");
const overlay = document.getElementById("sidebarOverlay");
const hamburger = document.getElementById("hamburgerBtn");

hamburger.addEventListener("click", () => {
  sidebar.classList.toggle("open");
  overlay.classList.toggle("active");
});
overlay.addEventListener("click", () => {
  sidebar.classList.remove("open");
  overlay.classList.remove("active");
});

/* ‚îÄ‚îÄ Periodic connection check (every 5 s, silent) ‚îÄ‚îÄ */
setInterval(async () => {
  try {
    const res = await fetch(API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ args: ["PING"] })
    });
    const data = await res.json();
    setConnected(data.ok);
  } catch { setConnected(false); }
}, 5000);

/* ‚îÄ‚îÄ Initial connection check ‚îÄ‚îÄ */
(async () => {
  try {
    const res = await fetch(API, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ args: ["PING"] }) });
    const data = await res.json();
    setConnected(data.ok);
  } catch { setConnected(false); }
})();

cmdInput.focus();
</script>
</body>
</html>
