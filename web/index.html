<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CackDB ‚Äî Test Console</title>
<style>
  :root {
    /* Modern Dark Theme */
    --bg-base: #0f172a;
    --bg-surface: #1e293b;
    --bg-surface-hover: #334155;
    --border-color: #334155;
    --text-main: #f8fafc;
    --text-muted: #94a3b8;
    
    --accent-primary: #3b82f6;
    --accent-primary-hover: #2563eb;
    
    --color-success: #10b981;
    --color-error: #ef4444;
    --color-warning: #f59e0b;
    --color-command: #a855f7;
    --color-string: #facc15;
    
    --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
    --font-mono: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
    
    --radius-sm: 4px;
    --radius-md: 8px;
    --radius-lg: 12px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  body { 
    background-color: var(--bg-base); 
    color: var(--text-main); 
    font-family: var(--font-sans); 
    height: 100vh; 
    overflow: hidden; 
    display: flex; 
    flex-direction: column; 
    -webkit-font-smoothing: antialiased;
  }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  header { 
    background-color: var(--bg-surface); 
    border-bottom: 1px solid var(--border-color); 
    padding: 16px 24px; 
    display: flex; 
    align-items: center; 
    gap: 16px; 
    position: relative; 
    z-index: 30;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }
  
  .logo {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 20px;
    font-weight: 700;
    letter-spacing: -0.5px;
  }
  
  .logo span { color: var(--accent-primary); }
  
  .status-badge {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 8px;
    background-color: rgba(255, 255, 255, 0.05);
    padding: 6px 12px;
    border-radius: 999px;
    font-size: 13px;
    font-weight: 500;
    border: 1px solid var(--border-color);
  }
  
  .status-dot { 
    width: 8px; 
    height: 8px; 
    border-radius: 50%; 
    background-color: var(--color-error); 
    box-shadow: 0 0 8px var(--color-error);
    transition: background-color 0.3s, box-shadow 0.3s; 
  }
  
  .status-dot.connected { 
    background-color: var(--color-success); 
    box-shadow: 0 0 8px var(--color-success);
  }

  /* Hamburger ‚Äî mobile */
  .hamburger { 
    display: none; 
    background: transparent; 
    border: none; 
    color: var(--text-main); 
    font-size: 24px; 
    cursor: pointer; 
    padding: 4px;
  }

  /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
  .container { display: flex; flex: 1; overflow: hidden; position: relative; }

  /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
  .sidebar { 
    width: 280px; 
    background-color: var(--bg-surface); 
    border-right: 1px solid var(--border-color); 
    display: flex; 
    flex-direction: column; 
    flex-shrink: 0;
    z-index: 20;
    transition: transform 0.3s ease;
  }
  
  .sidebar-inner {
    padding: 20px 16px;
    overflow-y: auto;
    flex: 1;
  }
  
  .sidebar-header { margin-bottom: 16px; }
  .sidebar-header h2 { 
    font-size: 11px; 
    text-transform: uppercase; 
    letter-spacing: 0.05em; 
    font-weight: 600;
    color: var(--text-muted); 
  }
  
  .sidebar-search {
    position: relative;
    margin-bottom: 20px;
  }
  
  .sidebar-search input {
    width: 100%;
    background-color: var(--bg-base);
    border: 1px solid var(--border-color);
    color: var(--text-main);
    font-family: var(--font-sans);
    font-size: 13px;
    padding: 10px 12px 10px 32px;
    border-radius: var(--radius-md);
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  
  .sidebar-search input:focus {
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
  }
  
  .sidebar-search::before {
    content: "üîç";
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    opacity: 0.6;
  }

  .cmd-group { margin-bottom: 24px; }
  .cmd-group h3 { 
    font-size: 13px; 
    color: var(--text-main); 
    margin-bottom: 10px; 
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 600;
  }
  
  .cmd-btn { 
    display: block; 
    width: 100%; 
    text-align: left; 
    background: transparent; 
    border: 1px solid transparent; 
    color: var(--text-muted); 
    padding: 8px 12px; 
    border-radius: var(--radius-sm); 
    font-family: var(--font-mono); 
    font-size: 12px; 
    cursor: pointer; 
    margin-bottom: 4px; 
    transition: all 0.2s ease;
  }
  
  .cmd-btn:hover { 
    background-color: var(--bg-surface-hover); 
    color: var(--text-main);
  }
  
  .cmd-btn.hidden { display: none; }

  .sidebar-overlay { 
    display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(2px); z-index: 19; 
    opacity: 0; transition: opacity 0.3s ease;
  }
  .sidebar-overlay.active { display: block; opacity: 1; }

  /* ‚îÄ‚îÄ Console Area ‚îÄ‚îÄ */
  .console-area { 
    flex: 1; 
    display: flex; 
    flex-direction: column; 
    overflow: hidden; 
    background-color: var(--bg-base);
  }

  .output { 
    flex: 1; 
    overflow-y: auto; 
    padding: 24px; 
    font-family: var(--font-mono); 
    font-size: 14px; 
    line-height: 1.6;
    scroll-behavior: smooth;
  }
  
  .output-inner {
    max-width: 900px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .welcome-panel {
    background-color: var(--bg-surface);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 24px;
    margin-bottom: 24px;
    color: var(--text-muted);
    font-family: var(--font-sans);
  }
  
  .welcome-panel h2 {
    color: var(--text-main);
    margin-bottom: 12px;
    font-size: 18px;
  }
  
  .welcome-panel code {
    background-color: var(--bg-base);
    padding: 2px 6px;
    border-radius: var(--radius-sm);
    font-family: var(--font-mono);
    font-size: 13px;
    color: var(--accent-primary);
  }
  
  .welcome-panel ol {
    margin-top: 12px;
    margin-left: 20px;
  }
  
  .welcome-panel li { margin-bottom: 8px; }

  /* Command Entry Styles */
  .entry { 
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .cmd-block {
    display: inline-flex;
    align-items: center;
    background-color: var(--bg-surface);
    border: 1px solid var(--border-color);
    padding: 8px 16px;
    border-radius: var(--radius-md);
    width: fit-content;
    max-width: 100%;
    position: relative;
  }
  
  .cmd-block::before {
    content: "‚ùØ";
    color: var(--accent-primary);
    margin-right: 12px;
    font-weight: bold;
  }

  .cmd-name { 
    color: var(--color-command); 
    font-weight: 600; 
    margin-right: 8px;
  }
  
  .cmd-args { color: var(--color-string); }
  
  .ts { 
    color: rgba(148, 163, 184, 0.4); 
    font-size: 11px; 
    margin-left: 16px;
    font-family: var(--font-sans);
  }

  .result-block { 
    display: flex; 
    align-items: flex-start; 
    gap: 12px; 
    padding-left: 16px;
    position: relative;
  }
  
  .result-block::before {
    content: "‚Ü≥";
    color: var(--text-muted);
    opacity: 0.5;
  }
  
  .result-content { 
    color: var(--text-main); 
    white-space: pre-wrap; 
    flex: 1;
    word-break: break-all;
  }
  
  .result-content.error { color: var(--color-error); }
  .result-content.nil { color: var(--text-muted); font-style: italic; }
  
  .copy-btn { 
    opacity: 0; 
    background: var(--bg-surface); 
    border: 1px solid var(--border-color); 
    color: var(--text-muted); 
    padding: 4px 8px; 
    border-radius: var(--radius-sm); 
    cursor: pointer; 
    transition: all 0.2s; 
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .result-block:hover .copy-btn { opacity: 1; }
  .copy-btn:hover { color: var(--text-main); border-color: var(--text-muted); }

  /* ‚îÄ‚îÄ Quick-action bar ‚îÄ‚îÄ */
  .action-bar { 
    background-color: var(--bg-base); 
    padding: 12px 24px; 
    display: flex; 
    gap: 12px; 
    align-items: center; 
    flex-wrap: wrap;
    border-top: 1px solid var(--border-color);
  }
  
  .action-bar button { 
    background-color: var(--bg-surface); 
    border: 1px solid var(--border-color); 
    color: var(--text-muted); 
    padding: 6px 14px; 
    border-radius: 999px; 
    font-size: 12px; 
    font-weight: 500;
    cursor: pointer; 
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .action-bar button:hover { 
    background-color: var(--bg-surface-hover); 
    color: var(--text-main);
    border-color: var(--text-muted);
  }
  
  .action-bar button.danger:hover {
    color: var(--color-error);
    border-color: rgba(239, 68, 68, 0.3);
    background-color: rgba(239, 68, 68, 0.1);
  }

  /* ‚îÄ‚îÄ Input bar ‚îÄ‚îÄ */
  .input-area { 
    background-color: var(--bg-surface); 
    padding: 16px 24px; 
    border-top: 1px solid var(--border-color);
  }
  
  .input-wrapper {
    display: flex; 
    align-items: center; 
    background-color: var(--bg-base);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 4px 4px 4px 16px;
    transition: border-color 0.2s, box-shadow 0.2s;
    max-width: 900px;
    margin: 0 auto;
  }
  
  .input-wrapper:focus-within {
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
  }
  
  .input-prefix { color: var(--accent-primary); font-family: var(--font-mono); font-weight: bold; }
  
  .input-area input { 
    flex: 1; 
    background: transparent; 
    border: none; 
    color: var(--text-main); 
    font-family: var(--font-mono); 
    font-size: 15px; 
    padding: 12px 16px; 
    outline: none; 
  }
  
  .input-area input::placeholder { color: var(--border-color); }
  .input-area input:disabled { opacity: 0.5; cursor: not-allowed; }
  
  #sendBtn { 
    background-color: var(--accent-primary); 
    color: white; 
    border: none; 
    padding: 10px 24px; 
    border-radius: calc(var(--radius-lg) - 4px); 
    font-size: 14px; 
    font-weight: 600; 
    cursor: pointer; 
    min-width: 80px; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    transition: background-color 0.2s;
  }
  
  #sendBtn:hover:not(:disabled) { background-color: var(--accent-primary-hover); }
  #sendBtn:disabled { opacity: 0.7; cursor: not-allowed; }

  /* Spinner */
  .spinner { 
    width: 18px; 
    height: 18px; 
    border: 2px solid rgba(255,255,255,0.3); 
    border-top-color: white; 
    border-radius: 50%; 
    animation: spin 0.8s linear infinite; 
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
  #toast { 
    position: fixed; 
    bottom: 24px; 
    right: 24px; 
    background-color: var(--bg-surface); 
    border: 1px solid var(--border-color); 
    color: var(--text-main); 
    font-size: 14px; 
    padding: 12px 20px; 
    border-radius: var(--radius-md); 
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); 
    z-index: 100; 
    opacity: 0; 
    transform: translateY(16px); 
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); 
    pointer-events: none;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  #toast.show { opacity: 1; transform: translateY(0); }
  #toast.success { border-bottom: 2px solid var(--color-success); }
  #toast.error { border-bottom: 2px solid var(--color-error); }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .hamburger { display: block; }
    .sidebar {
      position: fixed; top: 0; left: 0; height: 100%;
      transform: translateX(-100%);
    }
    .sidebar.open { transform: translateX(0); box-shadow: 4px 0 15px rgba(0,0,0,0.5); }
    .output { padding: 16px; }
    .input-area { padding: 12px 16px; }
    .action-bar { padding: 10px 16px; overflow-x: auto; flex-wrap: nowrap; }
  }
</style>
</head>
<body>

<header>
  <button class="hamburger" id="hamburgerBtn" aria-label="Toggle menu">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
  </button>
  <div class="logo">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--accent-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></svg>
    CackDB <span>Console</span>
  </div>
  <div class="status-badge" id="statusBadge">
    <div class="status-dot" id="statusDot"></div>
    <span id="statusText">Disconnected</span>
  </div>
</header>

<div id="sidebarOverlay" class="sidebar-overlay"></div>

<div class="container">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-inner">
      <div class="sidebar-search">
        <input type="search" id="sidebarFilter" placeholder="Filter commands‚Ä¶" autocomplete="off">
      </div>

      <div class="cmd-group" data-group="string">
        <h3><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path></svg> String / Int</h3>
        <button class="cmd-btn" data-cmd='SET test "hello world"'>SET test "hello world"</button>
        <button class="cmd-btn" data-cmd="GET test">GET test</button>
        <button class="cmd-btn" data-cmd="SET counter 0">SET counter 0</button>
        <button class="cmd-btn" data-cmd="INCR counter">INCR counter</button>
        <button class="cmd-btn" data-cmd="DECR counter">DECR counter</button>
        <button class="cmd-btn" data-cmd="DEL test counter">DEL test counter</button>
        <button class="cmd-btn" data-cmd="MSET a 1 b 2 c 3">MSET a 1 b 2 c 3</button>
        <button class="cmd-btn" data-cmd="MGET a b c">MGET a b c</button>
        <button class="cmd-btn" data-cmd="EXISTS test">EXISTS test</button>
      </div>

      <div class="cmd-group" data-group="list">
        <h3><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg> List</h3>
        <button class="cmd-btn" data-cmd="RPUSH mylist a b c">RPUSH mylist a b c</button>
        <button class="cmd-btn" data-cmd="LRANGE mylist 0 -1">LRANGE mylist 0 -1</button>
        <button class="cmd-btn" data-cmd="LPUSH mylist first">LPUSH mylist first</button>
        <button class="cmd-btn" data-cmd="LPOP mylist">LPOP mylist</button>
        <button class="cmd-btn" data-cmd="RPOP mylist">RPOP mylist</button>
        <button class="cmd-btn" data-cmd="LLEN mylist">LLEN mylist</button>
      </div>

      <div class="cmd-group" data-group="ttl">
        <h3><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> Expiration</h3>
        <button class="cmd-btn" data-cmd="SET session abc EX 60">SET session abc EX 60</button>
        <button class="cmd-btn" data-cmd="EXPIRE test 30">EXPIRE test 30</button>
        <button class="cmd-btn" data-cmd="TTL test">TTL test</button>
        <button class="cmd-btn" data-cmd="PERSIST test">PERSIST test</button>
      </div>

      <div class="cmd-group" data-group="server">
        <h3><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect><rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect><line x1="6" y1="6" x2="6.01" y2="6"></line><line x1="6" y1="18" x2="6.01" y2="18"></line></svg> Server</h3>
        <button class="cmd-btn" data-cmd="PING">PING</button>
        <button class="cmd-btn" data-cmd="DBSIZE">DBSIZE</button>
        <button class="cmd-btn" data-cmd="INFO">INFO</button>
        <button class="cmd-btn" data-cmd="SAVE">SAVE</button>
        <button class="cmd-btn" data-cmd="FLUSHDB">FLUSHDB</button>
      </div>
    </div>
  </aside>

  <main class="console-area">
    <div class="action-bar">
      <button onclick="sendCommand('DBSIZE')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"></path><path d="M3 15v4a2 2 0 0 0 2 2h16v-4"></path><path d="M3 10v4a2 2 0 0 0 2 2h16v-4"></path></svg> DB Size</button>
      <button onclick="sendCommand('PING')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg> Ping</button>
      <button onclick="clearOutput()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg> Clear</button>
      <button class="danger" onclick="flushAll()" style="margin-left: auto;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg> Flush All</button>
    </div>
    
    <div class="output" id="output">
      <div class="output-inner" id="outputInner">
        <div class="welcome-panel" id="welcomePanel">
          <h2>Welcome to CackDB Console</h2>
          <p>A fast, interactive terminal for testing your in-memory database. Start executing commands below or pick from the sidebar.
        </div>
      </div>
    </div>
    
    <div class="input-area">
      <div class="input-wrapper">
        <span class="input-prefix">‚ùØ</span>
        <input type="text" id="cmdInput" placeholder="Enter a command... (e.g., SET user:1 'Alice')" autocomplete="off" spellcheck="false">
        <button id="sendBtn" onclick="submitInput()">Send</button>
      </div>
    </div>
  </main>
</div>

<div id="toast"></div>

<script>
const API = "/cmd";
const outputInner = document.getElementById("outputInner");
const cmdInput = document.getElementById("cmdInput");
const statusDot = document.getElementById("statusDot");
const statusText = document.getElementById("statusText");
const sendBtn = document.getElementById("sendBtn");
const welcomePanel = document.getElementById("welcomePanel");

let history = [], historyIdx = -1;
let busy = false;
let hasExecutedCommand = false;

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
let toastTimer = null;
function showToast(msg, type = "") {
  const t = document.getElementById("toast");
  let icon = type === 'success' ? '‚úì ' : type === 'error' ? '‚ö† ' : '';
  t.innerHTML = `<span>${icon}${msg}</span>`;
  t.className = "show" + (type ? " " + type : "");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { t.className = ""; }, 3000);
}

/* ‚îÄ‚îÄ Tokenizer ‚îÄ‚îÄ */
function tokenize(line) {
  const args = [];
  let i = 0;
  while (i < line.length) {
    while (i < line.length && line[i] === " ") i++;
    if (i >= line.length) break;
    if (line[i] === '"' || line[i] === "'") {
      let quote = line[i];
      i++;
      let s = "";
      while (i < line.length && line[i] !== quote) s += line[i++];
      if (i < line.length) i++;
      args.push(s);
    } else {
      let s = "";
      while (i < line.length && line[i] !== " ") s += line[i++];
      args.push(s);
    }
  }
  return args;
}

/* ‚îÄ‚îÄ Loading state ‚îÄ‚îÄ */
function setLoading(on) {
  busy = on;
  cmdInput.disabled = on;
  sendBtn.disabled = on;
  if (on) {
    sendBtn.innerHTML = '<div class="spinner"></div>';
  } else {
    sendBtn.textContent = "Send";
    cmdInput.focus();
  }
}

/* ‚îÄ‚îÄ Send command ‚îÄ‚îÄ */
async function sendCommand(line, silent = false) {
  const args = tokenize(line.trim());
  if (args.length === 0) return;
  
  if (!hasExecutedCommand) {
    if (welcomePanel) welcomePanel.style.display = 'none';
    hasExecutedCommand = true;
  }
  
  if (!silent) appendCmd(line);
  setLoading(true);
  try {
    const res = await fetch(API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ args })
    });
    const data = await res.json();
    if (!silent) {
      const isErr = data.result.startsWith("(error)");
      const isNil = data.result === "(nil)";
      appendResult(data.result, isErr ? "error" : isNil ? "nil" : "");
    }
    setConnected(data.ok);
    return data;
  } catch (e) {
    if (!silent) appendResult("Connection error: " + e.message, "error");
    setConnected(false);
  } finally {
    setLoading(false);
  }
}

/* ‚îÄ‚îÄ FLUSHDB ‚îÄ‚îÄ */
function flushAll() {
  if (!confirm("‚ö†Ô∏è This will delete ALL keys from the database.\n\nAre you sure?")) return;
  sendCommand("FLUSHDB");
}

/* ‚îÄ‚îÄ Submit from input bar ‚îÄ‚îÄ */
function submitInput() {
  if (busy) return;
  const line = cmdInput.value.trim();
  if (!line) return;
  history.unshift(line);
  historyIdx = -1;
  
  const cmd = line.trim().toUpperCase().split(/\s+/)[0];
  if (cmd === "FLUSHDB" || cmd === "FLUSHALL") {
    if (!confirm("‚ö†Ô∏è This will delete ALL keys from the database.\n\nAre you sure?")) return;
  }
  sendCommand(line);
  cmdInput.value = "";
}

/* ‚îÄ‚îÄ Append command line ‚îÄ‚îÄ */
function appendCmd(text) {
  const ts = new Date().toLocaleTimeString([], { hour12: false });
  const tokens = text.trim().split(/\s+/);
  const cmdName = tokens[0] || "";
  const rest = tokens.slice(1).join(" ");

  const div = document.createElement("div");
  div.className = "entry";

  const cmdBlock = document.createElement("div");
  cmdBlock.className = "cmd-block";

  const nameSpan = document.createElement("span");
  nameSpan.className = "cmd-name";
  nameSpan.textContent = cmdName.toUpperCase();
  cmdBlock.appendChild(nameSpan);

  if (rest) {
    const argsSpan = document.createElement("span");
    argsSpan.className = "cmd-args";
    argsSpan.textContent = rest;
    cmdBlock.appendChild(argsSpan);
  }

  const tsSpan = document.createElement("span");
  tsSpan.className = "ts";
  tsSpan.textContent = ts;
  cmdBlock.appendChild(tsSpan);

  div.appendChild(cmdBlock);
  outputInner.appendChild(div);
  scrollToBottom();
}

/* ‚îÄ‚îÄ Append result ‚îÄ‚îÄ */
function appendResult(text, cls) {
  const entries = outputInner.querySelectorAll(".entry");
  const last = entries[entries.length - 1];
  if (!last) return;

  const resultBlock = document.createElement("div");
  resultBlock.className = "result-block";

  const contentDiv = document.createElement("div");
  contentDiv.className = "result-content " + (cls || "");
  contentDiv.textContent = text;

  const copyBtn = document.createElement("button");
  copyBtn.className = "copy-btn";
  copyBtn.title = "Copy result";
  copyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
  copyBtn.addEventListener("click", () => {
    navigator.clipboard.writeText(text).then(() => {
      showToast("Copied to clipboard", "success");
    }).catch(() => showToast("Copy failed", "error"));
  });

  resultBlock.appendChild(contentDiv);
  resultBlock.appendChild(copyBtn);
  last.appendChild(resultBlock);
  scrollToBottom();
}

function scrollToBottom() {
  const out = document.getElementById("output");
  out.scrollTop = out.scrollHeight;
}

function clearOutput() { 
  outputInner.innerHTML = ""; 
  hasExecutedCommand = false;
  if (welcomePanel) {
    welcomePanel.style.display = 'block';
    outputInner.appendChild(welcomePanel);
  }
}

function setConnected(ok) {
  statusDot.className = "status-dot" + (ok ? " connected" : "");
  statusText.textContent = ok ? "Connected" : "Disconnected";
}

/* ‚îÄ‚îÄ Keyboard navigation ‚îÄ‚îÄ */
cmdInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") { e.preventDefault(); submitInput(); }
  if (e.key === "ArrowUp") { 
    e.preventDefault(); 
    if (historyIdx < history.length - 1) { 
      historyIdx++; 
      cmdInput.value = history[historyIdx]; 
    } 
  }
  if (e.key === "ArrowDown") { 
    e.preventDefault(); 
    if (historyIdx > 0) { 
      historyIdx--; 
      cmdInput.value = history[historyIdx]; 
    } else { 
      historyIdx = -1; 
      cmdInput.value = ""; 
    } 
  }
});

/* ‚îÄ‚îÄ Quick commands ‚îÄ‚îÄ */
document.querySelectorAll(".cmd-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const cmd = btn.getAttribute("data-cmd");
    cmdInput.value = cmd;
    submitInput();
    if(window.innerWidth <= 768) {
      document.getElementById("sidebar").classList.remove("open");
      document.getElementById("sidebarOverlay").classList.remove("active");
    }
  });
});

/* ‚îÄ‚îÄ Sidebar filter ‚îÄ‚îÄ */
document.getElementById("sidebarFilter").addEventListener("input", function () {
  const q = this.value.trim().toLowerCase();
  document.querySelectorAll(".cmd-group").forEach(group => {
    let anyVisible = false;
    group.querySelectorAll(".cmd-btn").forEach(btn => {
      const match = !q || btn.getAttribute("data-cmd").toLowerCase().includes(q);
      btn.classList.toggle("hidden", !match);
      if (match) anyVisible = true;
    });
    group.style.display = anyVisible ? "" : "none";
  });
});

/* ‚îÄ‚îÄ Mobile sidebar ‚îÄ‚îÄ */
const sidebar = document.getElementById("sidebar");
const overlay = document.getElementById("sidebarOverlay");
const hamburger = document.getElementById("hamburgerBtn");

hamburger.addEventListener("click", () => {
  sidebar.classList.toggle("open");
  overlay.classList.toggle("active");
});
overlay.addEventListener("click", () => {
  sidebar.classList.remove("open");
  overlay.classList.remove("active");
});

/* ‚îÄ‚îÄ Connection check ‚îÄ‚îÄ */
setInterval(async () => {
  try {
    const res = await fetch(API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ args: ["PING"] })
    });
    const data = await res.json();
    setConnected(data.ok);
  } catch { setConnected(false); }
}, 5000);

(async () => {
  try {
    const res = await fetch(API, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ args: ["PING"] }) });
    const data = await res.json();
    setConnected(data.ok);
  } catch { setConnected(false); }
})();

cmdInput.focus();
</script>
</body>
</html>